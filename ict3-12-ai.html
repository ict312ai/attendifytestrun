<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendify</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Bootswatch Simplex Theme -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootswatch/4.5.2/simplex/bootstrap.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
        }
        .container {
            margin-top: 20px;
        }
        .card {
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .table {
            margin-top: 20px;
        }
        .table th, .table td {
            text-align: center;
            vertical-align: middle;
        }
        .button-container {
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
        }
        .qr-container {
            text-align: center;
            margin-bottom: 20px;
        }
        .qr-code {
            width: 200px;
            height: 200px;
            border-radius: 10px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            position: relative;
            margin: auto;
        }
        .logo {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
        }
        .date-selector {
            margin-bottom: 20px;
        }

        /* Custom colors for attendance status */
        .status-present {
            color: #28a745; /* Green */
            font-weight: bold;
        }
        .status-late {
            color: #fd7e14; /* Orange */
            font-weight: bold;
        }
        .status-absent {
            color: #dc3545; /* Red */
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #A40000;">
        <a class="navbar-brand" href="index.html">UE | Attendify</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="index.html">Home</a>
                </li>
                <li class="nav-item active">
                    <a class="nav-link" href="classes.html">Classes <span class="sr-only">(current)</span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="students.html">Students</a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Date Selector Section -->
    <div class="container">
        <div class="card">
            <div class="card-header" style="background-color: #A40000; color: white;">
                <h3 class="mb-0"></h3>
            </div>
            <div class="card-body">
                <div class="date-selector">
                    <label for="cutoffDate"></label>
                    <input type="datetime-local" id="cutoffDate" class="form-control">
                </div>
            </div>
        </div>
    </div>

    <!-- QR Code Generator Section -->
    <div class="container">
        <div class="card">
            <div class="card-header" style="background-color: #A40000; color: white;">
                <h3 class="mb-0"></h3>
            </div>
            <div class="card-body">
                <div class="qr-container">
                    <div id="qrcode" class="qr-code"></div>
                </div>
                <button class="btn" style="background-color: #A40000; color: white;" onclick="generateQRCode()">Generate QR Code</button>
            </div>
        </div>
    </div>

    <!-- Attendance List Section -->
    <div class="container">
        <div class="card">
            <div class="card-header" style="background-color: #A40000; color: white;">
                <h3 class="mb-0">Real-Time Attendance List</h3>
            </div>
            <div class="card-body">
                <table class="table table-bordered table-striped">
                    <thead class="thead-dark" style="background-color: #A40000;">
                        <tr>
                            <th>#</th>
                            <th>Student/Teacher ID</th>
                            <th>Name</th>
                            <th>Role</th>
                            <th>Timestamp</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceList">
                        <!-- Attendance data will be populated here -->
                    </tbody>
                </table>
            </div>
            <div class="button-container">
                <button class="btn btn-danger" id="resetBtn">Reset</button>
                <button class="btn" style="background-color: #A40000; color: white;" id="exportBtn">Export to CSV</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getDatabase, ref, onChildAdded, remove } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA0hTRuEgjrP9YQ4LwkHcSUf7xkdl9lBgI",
            authDomain: "attendify12-ai.firebaseapp.com",
            databaseURL: "https://attendify12-ai-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "attendify12-ai",
            storageBucket: "attendify12-ai.firebasestorage.app",
            messagingSenderId: "374044642888",
            appId: "1:374044642888:web:44706986d500af43a0927d"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        const attendanceRef = ref(database, 'attendance/');
        const attendanceList = document.getElementById('attendanceList');
        let count = 0;

        // Fetch and load the stored cutoff date from localStorage if exists
        const storedCutoffDate = localStorage.getItem("cutoffDate");
        if (storedCutoffDate) {
            document.getElementById("cutoffDate").value = storedCutoffDate;
        }

        // Listen for new attendance records and display them
        onChildAdded(attendanceRef, (snapshot) => {
            const data = snapshot.val();
            const cutoffDate = document.getElementById('cutoffDate').value; // Get the cutoff date from input

            // If no cutoff date is selected, we won't mark the status
            if (!cutoffDate) {
                return;
            }

            const cutoffTimestamp = new Date(cutoffDate).getTime();
            let status = "Absent"; // Default status is "Absent" if no record found

            // Compare login timestamp with cutoff date/time
            if (new Date(data.timestamp).getTime() <= cutoffTimestamp) {
                status = "Present";
            } else {
                status = "Late";
            }

            // Apply color styling based on status
            let statusClass = "";
            if (status === "Present") {
                statusClass = "status-present";
            } else if (status === "Late") {
                statusClass = "status-late";
            } else {
                statusClass = "status-absent";
            }

            const currentTime = new Date(data.timestamp).toLocaleString();

            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${++count}</td>
                <td>${data.id}</td>
                <td>${data.name}</td>
                <td>${data.role}</td>
                <td>${currentTime}</td>
                <td class="${statusClass}">${status}</td>
            `;

            attendanceList.appendChild(newRow);
        });

        // Save the selected cutoff date to localStorage
        document.getElementById('cutoffDate').addEventListener('change', (e) => {
            localStorage.setItem("cutoffDate", e.target.value);
        });

        // Reset Button Functionality
        document.getElementById('resetBtn').addEventListener('click', () => {
            // Clear the attendance table, but not the data in Firebase
            attendanceList.innerHTML = '';
            count = 0;  // Reset count

            // Reset attendance data in Firebase
            remove(attendanceRef).then(() => {
                console.log('Attendance data has been cleared from the database.');
            }).catch((error) => {
                console.error('Error clearing attendance data: ', error);
            });
        });

        // Export Button Functionality
        document.getElementById('exportBtn').addEventListener('click', () => {
            // Prepare CSV data
            const rows = [['#', 'Student/Teacher ID', 'Name', 'Role', 'Timestamp', 'Status']];
            const tableRows = attendanceList.getElementsByTagName('tr');

            for (let row of tableRows) {
                const rowData = Array.from(row.getElementsByTagName('td')).map(cell => cell.textContent);
                rows.push(rowData);
            }

            // Create CSV file content
            const csvContent = rows.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'attendance_list.csv';
            link.click();
        });
    </script>

    <script>
        // QR Code Generator Function
        function generateQRCode() {
            var baseUrl = "";
            var randomQuery = Math.random().toString(36).substring(2, 15);
            var finalUrl = baseUrl + "?id=" + randomQuery;

            document.getElementById("qrcode").innerHTML = "";

            new QRCode(document.getElementById("qrcode"), {
                text: finalUrl,
                width: 200,
                height: 200,
                colorDark: "#A40000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });

            var logo = document.createElement("img");
            logo.src = "ue-logo.png";  
            logo.classList.add("logo");
            document.getElementById("qrcode").appendChild(logo);
        }
    </script>
</body>
</html>
